# 修复测试指南

## 修复内容

### 1. 鼠标拖拽问题修复

**问题描述：** 鼠标无法拖拽界面

**修复内容：**
- 改进了 `client_piko/web/js/client.js` 中的鼠标拖拽逻辑
- 在拖拽时发送正确的鼠标事件，保持按下状态而不是重复发送按下事件

**测试方法：**
1. 启动RDP连接
2. 尝试拖拽窗口标题栏
3. 尝试拖拽文件或文件夹
4. 检查拖拽操作是否正常

### 2. 全黑位图检测

**问题描述：** 有部分位图无法更新，显示为全黑

**修复内容：**
- 在后端 `client_piko/bitmap.go` 中添加了全黑位图检测
- 在前端 `client_piko/web/js/canvas.js` 和 `client_piko/web/js/client.js` 中添加了全黑位图检测
- 当检测到全黑位图时，会打印详细的警告信息和数据预览

**测试方法：**
1. 启动RDP连接
2. 观察控制台日志
3. 当出现全黑位图时，会看到类似以下的警告信息：

```
⚠️ 检测到全黑位图数据！矩形 0 详情: {
  destLeft: 0,
  destTop: 0,
  destRight: 100,
  destBottom: 100,
  width: 100,
  height: 100,
  bitsPerPixel: 24,
  isCompress: false,
  dataLength: 30000,
  sampleCount: 100
}
矩形 0 全黑数据预览: 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, ...
```

## 日志查看

### 后端日志
```bash
# 查看后端日志，寻找全黑位图警告
grep "检测到全黑位图" logs/app.log
grep "检测到全黑输出" logs/app.log
```

### 前端日志
在浏览器开发者工具的控制台中查看：
- 搜索 "全黑位图"
- 搜索 "全黑解码数据"
- 搜索 "全黑输出"

## 调试建议

1. **启用调试模式：**
   ```bash
   export IMAGE_DEBUG=true
   ```

2. **查看详细日志：**
   - 后端：设置日志级别为 DEBUG
   - 前端：打开浏览器开发者工具

3. **测试场景：**
   - 快速移动鼠标
   - 切换窗口
   - 打开/关闭应用程序
   - 滚动页面

## 预期效果

1. **鼠标拖拽：** 应该能够正常拖拽窗口和文件
2. **全黑位图检测：** 当出现全黑位图时，会在日志中看到详细的警告信息，帮助定位问题
3. **性能：** 拖拽操作应该流畅，不会出现卡顿

## 注意事项

- 全黑位图检测会增加一些性能开销，但有助于问题诊断
- 如果频繁出现全黑位图，可能需要检查RDP连接质量或服务器配置
- 鼠标拖拽修复主要针对RDP协议，确保与远程桌面的交互正常 