<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../img/favicon.ico">

    <title>Mstsc.js</title>

    <!-- Bootstrap core CSS -->
    <link href="../css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="../css/signin.css" rel="stylesheet">
	<script type="text/javascript" src="../js/mstsc.js"></script>
	<script type="text/javascript" src="../js/keyboard.js"></script>
	<script type="text/javascript" src="../js/rle.js"></script>
	<script type="text/javascript" src="../js/client.js"></script>
	<script type="text/javascript" src="../js/canvas.js"></script>
    <script language="javascript">
    var client = null;
    var ws = null;
    var autoConnectAttempted = false;
    
    // 等待模块加载完成
    function waitForModulesAndLoad() {
        // 检查必要的模块是否已加载
        if (typeof Mstsc !== 'undefined' && typeof Mstsc.$ !== 'undefined') {
            initializePage();
        } else {
            setTimeout(waitForModulesAndLoad, 100);
        }
    }
    
    // 强制刷新canvas尺寸的函数
    function refreshCanvasSize() {
        var canvas = Mstsc.$("myCanvas");
        if (!canvas) {
            return;
        }
        
        // 确保canvas可见
        if (canvas.style.display === 'none') {
            canvas.style.display = 'inline';
        }
        
        // 获取窗口尺寸
        var canvasWidth = window.innerWidth;
        var canvasHeight = window.innerHeight;
        
        // 设置canvas的CSS尺寸
        canvas.style.width = canvasWidth + 'px';
        canvas.style.height = canvasHeight + 'px';
        
        // 等待CSS应用后再设置像素尺寸
        setTimeout(function() {
            // 重新获取显示尺寸（CSS应用后）
            var displayWidth = canvas.clientWidth || canvas.offsetWidth || canvasWidth;
            var displayHeight = canvas.clientHeight || canvas.offsetHeight || canvasHeight;
            
            // 设置canvas的实际像素尺寸
            canvas.width = displayWidth;
            canvas.height = displayHeight;
            
            console.log('[index.html] Canvas尺寸已设置:', {
                cssWidth: canvas.style.width,
                cssHeight: canvas.style.height,
                pixelWidth: canvas.width,
                pixelHeight: canvas.height,
                displayWidth: displayWidth,
                displayHeight: displayHeight
            });
            
            // 验证设置结果
            var rect = canvas.getBoundingClientRect();
            if (canvas.width <= 0 || canvas.height <= 0) {
                console.error('[index.html] Canvas尺寸设置失败');
                return;
            }
            
            // 触发RDP界面刷新
            triggerRDPFlush();
        }, 50);
    }
    
    // 触发RDP界面刷新的函数
    function triggerRDPFlush() {
        // 方法1: 通过WebSocket发送flush消息
        if (ws && ws.readyState === WebSocket.OPEN) {
            var message = {
                event: 'flush',
                data: {
                    reason: 'canvas-resize',
                    timestamp: Math.floor(Date.now() / 1000) // 修改为秒级时间戳，与后端对齐
                }
            };
            ws.send(JSON.stringify(message));
        }
        
        // 方法2: 通过HTTP API发送flush请求
        fetch('./api/flush', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                reason: 'canvas-resize',
                timestamp: Math.floor(Date.now() / 1000) // 修改为秒级时间戳，与后端对齐
            })
        })
        .then(response => response.json())
        .then(data => {
            // HTTP flush响应处理
        })
        .catch(error => {
            // HTTP flush请求失败处理
        });
    }
    
    // 初始化页面
    function initializePage() {
        // 添加窗口大小变化监听器
        window.addEventListener('resize', function() {
            // 使用防抖，避免频繁调用
            clearTimeout(window.resizeTimeout);
            window.resizeTimeout = setTimeout(function() {
                refreshCanvasSize();
            }, 100);
        });
        
        // 初始化client - 添加延迟确保DOM完全加载
        setTimeout(function() {
            var canvas = Mstsc.$("myCanvas");
            
            if (canvas) {
                load(canvas);
            } else {
                var canvasById = document.getElementById("myCanvas");
                
                if (canvasById) {
                    load(canvasById);
                }
            }
        }, 100);
    }
    
    function load (canvas) {
    	// 验证canvas参数
    	if (!canvas) {
    		return;
    	}
    	
    	if (!canvas.getContext) {
    		return;
    	}
    	
    	// 等待Module初始化完成
    	if (typeof Module === 'undefined') {
    		setTimeout(function() {
    			load(canvas);
    		}, 100);
    		return;
    	}
    	
    	if (!Module.HEAPU8) {
    		setTimeout(function() {
    			load(canvas);
    		}, 100);
    		return;
    	}
    	
    	// 检查内存管理函数
    	if (typeof Module._malloc !== 'function' || typeof Module._free !== 'function') {
    		setTimeout(function() {
    			load(canvas);
    		}, 100);
    		return;
    	}
    	
    	// 检查ccall函数
    	if (typeof Module.ccall !== 'function') {
    		setTimeout(function() {
    			load(canvas);
    		}, 100);
    		return;
    	}
    	
    	// 检查Mstsc.client是否存在
    	if (typeof Mstsc === 'undefined' || typeof Mstsc.client === 'undefined') {
    		setTimeout(function() {
    			load(canvas);
    		}, 100);
    		return;
    	}
    	
    	// 检查Mstsc.Canvas是否存在
    	if (typeof Mstsc.Canvas === 'undefined') {
    		setTimeout(function() {
    			load(canvas);
    		}, 100);
    		return;
    	}
    	
    	// 检查解压缩函数 - 使用不带下划线前缀的函数名（用于ccall调用）
    	var decompressFunctions = ['bitmap_decompress_15', 'bitmap_decompress_16', 'bitmap_decompress_24', 'bitmap_decompress_32'];
    	
    	// 由于ccall函数存在，我们假设解压缩函数也可以通过ccall调用
    	// 实际的函数存在性检查将在运行时进行
    	
    	client = Mstsc.client.create(canvas);
    	
    	// 初始化WebSocket连接和状态检查
    	initWebSocket();
    } 
    
    // 初始化WebSocket连接
    function initWebSocket() {
        // 获取当前页面的WebSocket URL
        var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        
        // 使用 window.location.href 获取完整URL，然后构建WebSocket URL
        var currentUrl = window.location.href;
        var urlObj = new URL(currentUrl);
        var wsUrl = protocol + "//" + urlObj.host + urlObj.pathname + "ws";
        
        ws = new WebSocket(wsUrl);
        window.ws = ws;
        
        ws.onopen = function() {
            // 连接建立后检查RDP状态
            checkRDPStatus();
            
            // 如果是重连，触发RDP界面刷新
            if (window.wsReconnected) {
                setTimeout(function() {
                    triggerRDPFlush();
                }, 1000); // 等待1秒后执行刷新
                window.wsReconnected = false;
            }
        };
        
        ws.onmessage = function(event) {
            try {
                var message = JSON.parse(event.data);
                
                if (message.event === 'status') {
                    handleStatusUpdate(message.data);
                } else if (message.event === 'rdp-connect') {
                    handleRDPConnect(message.data);
                } else if (message.event === 'rdp-error') {
                    handleRDPError(message.data);
                } else if (message.event === 'rdp-close') {
                    handleRDPClose();
                } else if (message.event === 'connection_rejected') {
                    // 处理WebSocket连接被拒绝的情况
                    handleConnectionRejected(message.data);
                } else if (message.event === 'rdp-bitmap') {
                    // 将 rdp-bitmap 事件转发给 client.js 处理
                    if (client && typeof client.handleBitmapMessage === 'function') {
                        // 调用 client.js 的专用处理方法
                        client.handleBitmapMessage(message);
                    } else if (client && client.socket && client.socket.onmessage) {
                        // 直接调用 client.js 的消息处理器
                        try {
                            client.socket.onmessage(event);
                        } catch (e) {
                            // 调用 client.js 消息处理器失败
                        }
                    }
                }
            } catch (e) {
                // 解析WebSocket消息失败
            }
        };
        
        ws.onerror = function(error) {
            // 显示WebSocket连接错误
            showConnectionError('WebSocket连接错误，请检查网络连接');
        };
        
        ws.onclose = function(event) {
            // 检查是否是连接被拒绝导致的关闭
            if (event.code === 1000 && event.reason === '') {
                // 正常关闭，可能是连接被拒绝后服务器主动关闭
            } else {
                // 显示连接关闭信息
                showConnectionError('WebSocket连接已关闭，正在尝试重新连接...');
            }
            
            // 设置重连标志
            window.wsReconnected = true;
            // 尝试重新连接
            setTimeout(function() {
                initWebSocket();
            }, 3000);
        };
    }
    
    // 检查RDP状态
    function checkRDPStatus() {
        fetch('./api/rdp-status')
            .then(response => response.json())
            .then(data => {
                if (data.connected) {
                    // 如果RDP已连接，直接跳转到画布界面
                    showReusedConnectionMessage('检测到现有RDP连接，正在跳转...');
                    setTimeout(function() {
                        switchToCanvas();
                    }, 1000);
                } else {
                    // 如果RDP未连接，检查是否有配置信息可以自动连接
                    checkAutoConnect();
                }
            })
            .catch(error => {
                // 即使状态检查失败，也尝试自动连接
                checkAutoConnect();
            });
    }
    
    // 检查是否可以自动连接
    function checkAutoConnect() {
        if (autoConnectAttempted) {
            return; // 已经尝试过自动连接
        }
        
        // 检查是否有配置信息
        fetch('./api/rdp-info')
            .then(response => response.json())
            .then(data => {
                // 检查是否有足够的信息进行自动连接
                if (data.host && data.user) {
                    autoConnectAttempted = true;
                    autoConnectToRDP();
                } else {
                    showLoginForm('', '', '');
                }
            })
            .catch(error => {
                // 获取RDP配置信息失败
            });
    }
    
    // 自动连接到RDP
    function autoConnectToRDP() {
        // 获取配置信息
        fetch('./api/rdp-info')
            .then(response => response.json())
            .then(data => {
                var host = data.host || '';
                var user = data.user || '';
                var domain = data.domain || '';
                
                // 检查是否有足够的信息进行自动连接
                if (!host || !user) {
                    showLoginForm(host, user, domain);
                    return;
                }
                
                // 检查是否有密码配置
                fetch('./api/rdp-status')
                    .then(response => response.json())
                    .then(statusData => {
                        var hasPassword = statusData.config && statusData.config.xrdpPass && statusData.config.xrdpPass !== '';
                        
                        if (!hasPassword) {
                            showLoginForm(host, user, domain);
                            return;
                        }
                        
                        // 有密码配置，尝试自动连接
                        var connectData = {
                            host: host,
                            username: user,
                            password: statusData.config.xrdpPass, // 使用配置中的密码
                            domain: domain,
                            width: 1280,
                            height: 720
                        };
                        
                        // 发送连接请求
                        fetch('./api/connect', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(connectData)
                        })
                        .then(response => response.json())
                        .then(result => {
                            if (result.success) {
                                if (result.reused) {
                                    // 复用现有连接
                                    showReusedConnectionMessage('复用现有RDP连接');
                                    setTimeout(function() {
                                        switchToCanvas();
                                    }, 1000);
                                } else {
                                    // 新连接，等待连接完成
                                    showReusedConnectionMessage('正在建立RDP连接...');
                                }
                            } else {
                                showReusedConnectionMessage('连接失败: ' + result.error);
                                // 连接失败时显示登录界面
                                showLoginForm(host, user, domain);
                            }
                        })
                        .catch(error => {
                            showReusedConnectionMessage('连接请求失败');
                            // 请求失败时显示登录界面
                            showLoginForm(host, user, domain);
                        });
                    })
                    .catch(error => {
                        // 状态获取失败时显示登录界面
                        showLoginForm(host, user, domain);
                    });
            })
            .catch(error => {
                // 获取RDP配置失败
            });
    }
    
    // 处理状态更新
    function handleStatusUpdate(status) {
        if (status.rdp === 'connected') {
            // RDP已连接，跳转到画布界面
            setTimeout(function() {
                switchToCanvas();
            }, 500);
        }
    }
    
    // 处理RDP连接成功
    function handleRDPConnect(data) {
        if (data.reused) {
            showReusedConnectionMessage('复用现有RDP连接');
        } else {
            showReusedConnectionMessage('RDP连接成功建立');
        }
        setTimeout(function() {
            switchToCanvas();
        }, 1000);
    }
    
    // 处理RDP错误
    function handleRDPError(data) {
        showReusedConnectionMessage('RDP连接错误: ' + data.message);
        // 显示登录界面
        showLoginForm('', '', '');
    }
    
    // 处理RDP连接关闭
    function handleRDPClose() {
        showReusedConnectionMessage('RDP连接已关闭');
        // 显示登录界面
        showLoginForm('', '', '');
    }
    
    // 处理WebSocket连接被拒绝
    function handleConnectionRejected(data) {
        // 构建详细的错误信息
        var errorMessage = 'WebSocket连接被拒绝: ' + (data.message || data.error || '未知原因');
        
        // 如果有详细信息，添加到错误消息中
        if (data.details) {
            errorMessage += '<br><br><strong>详细信息:</strong><br>';
            if (data.details.existingClient) {
                errorMessage += '现有客户端: ' + data.details.existingClient + '<br>';
            }
            if (data.details.newClient) {
                errorMessage += '新客户端: ' + data.details.newClient + '<br>';
            }
            if (data.details.timestamp) {
                var date = new Date(data.details.timestamp * 1000);
                errorMessage += '时间: ' + date.toLocaleString() + '<br>';
            }
        }
        
        // 显示错误信息
        showConnectionError(errorMessage);
        
        // 显示登录界面
        showLoginForm('', '', '');
    }
    
    // 切换到canvas界面
    function switchToCanvas() {
        // 隐藏登录界面
        Mstsc.$("main").style.display = 'none';
        
        // 显示canvas
        var canvas = Mstsc.$("myCanvas");
        canvas.style.display = 'inline';
        
        // 强制刷新canvas尺寸
        refreshCanvasSize();
        
        // 等待canvas尺寸设置完成
        setTimeout(function() {
            // 验证canvas尺寸
            if (canvas.width <= 0 || canvas.height <= 0) {
                console.error('[index.html] Canvas尺寸无效，无法切换到canvas界面');
                Mstsc.$("main").style.display = 'inline';
                Mstsc.$("myCanvas").style.display = 'none';
                return;
            }
            
            console.log('[index.html] 已切换到canvas界面，尺寸:', canvas.width, 'x', canvas.height);
            
            // 请求初始位图
            requestInitialBitmap();
        }, 100);
    }
    
    // 请求初始位图数据
    function requestInitialBitmap() {
        if (ws && ws.readyState === WebSocket.OPEN) {
            var message = {
                event: 'request-initial-bitmap',
                data: {
                    width: Mstsc.$("myCanvas").width,
                    height: Mstsc.$("myCanvas").height,
                    timestamp: Math.floor(Date.now() / 1000)
                }
            };
            ws.send(JSON.stringify(message));
            console.log('[index.html] 已发送初始位图请求');
        }
    }
    
    // 显示复用连接信息的函数
    function showReusedConnectionMessage(message) {
        // 创建一个简单的提示框
        var alertDiv = document.createElement('div');
        alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; border: 1px solid #c3e6cb; z-index: 1000; max-width: 400px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); font-size: 14px; line-height: 1.4;';
        alertDiv.innerHTML = '<strong>连接信息:</strong><br>' + message;
        document.body.appendChild(alertDiv);
        
        // 添加关闭按钮
        var closeBtn = document.createElement('button');
        closeBtn.innerHTML = '×';
        closeBtn.style.cssText = 'position: absolute; top: 5px; right: 10px; background: none; border: none; font-size: 18px; color: #155724; cursor: pointer; font-weight: bold;';
        closeBtn.onclick = function() {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        };
        alertDiv.appendChild(closeBtn);
        
        // 3秒后自动移除提示
        setTimeout(function() {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 5000);
    }

    // 显示WebSocket连接错误的函数
    function showConnectionError(message) {
        var alertDiv = document.createElement('div');
        alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; border: 1px solid #f5c6cb; z-index: 1000; max-width: 400px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); font-size: 14px; line-height: 1.4;';
        alertDiv.innerHTML = '<strong>连接错误:</strong><br>' + message;
        document.body.appendChild(alertDiv);

        // 添加关闭按钮
        var closeBtn = document.createElement('button');
        closeBtn.innerHTML = '×';
        closeBtn.style.cssText = 'position: absolute; top: 5px; right: 10px; background: none; border: none; font-size: 18px; color: #721c24; cursor: pointer; font-weight: bold;';
        closeBtn.onclick = function() {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        };
        alertDiv.appendChild(closeBtn);

        // 5秒后自动移除
        setTimeout(function() {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 8000); // 错误提示显示8秒
    }
    
    // 将函数暴露到全局作用域
    window.showReusedConnectionMessage = showReusedConnectionMessage;
    
    // 显示登录界面并预填充字段
    function showLoginForm(host, user, domain) {
        // 确保登录界面可见
        Mstsc.$("main").style.display = 'inline';
        Mstsc.$("myCanvas").style.display = 'none';
        
        // 预填充表单字段
        if (host) document.getElementById('inputIpAddress').value = host;
        if (user) document.getElementById('inputUsername').value = user;
        if (domain) document.getElementById('inputDomain').value = domain;
        
        // 将焦点设置到密码输入框
        setTimeout(function() {
            var passwordInput = document.getElementById('inputPassword');
            if (passwordInput) {
                passwordInput.focus();
            }
        }, 100);
    }
    
	function connect (ip, domain, username, password) {
		Mstsc.$("main").style.display = 'none';
		
		var canvas = Mstsc.$("myCanvas");
		
		// 确保canvas可见
		canvas.style.display = 'inline';
		
		// 强制刷新canvas尺寸
		refreshCanvasSize();
		
		// 等待canvas尺寸设置完成后再连接
		setTimeout(function() {
			// 验证canvas尺寸
			if (canvas.width <= 0 || canvas.height <= 0) {
				console.error('[index.html] Canvas尺寸无效，无法建立连接');
				Mstsc.$("main").style.display = 'inline';
				Mstsc.$("myCanvas").style.display = 'none';
				return;
			}
			
			// 验证canvas是否可见
			if (canvas.style.display === 'none') {
				canvas.style.display = 'inline';
			}
			
			console.log('[index.html] 开始RDP连接，Canvas尺寸:', canvas.width, 'x', canvas.height);
			
			client.connect(ip, domain, username, password, function (err) {
				if (err) {
					// 连接失败时隐藏canvas，显示登录界面
					Mstsc.$("myCanvas").style.display = 'none';
					Mstsc.$("main").style.display = 'inline';
				} else {
					// 连接成功时保持canvas显示，请求初始位图
					requestInitialBitmap();
				}
			});
		}, 100);
	}

    // 调试canvas状态的函数
    function debugCanvasState() {
        var canvas = Mstsc.$("myCanvas");
        if (!canvas) {
            return;
        }
        
        var rect = canvas.getBoundingClientRect();
        // Canvas状态调试信息
    }
    
    // 将调试函数暴露到全局作用域
    window.debugCanvasState = debugCanvasState;
    window.refreshCanvasSize = refreshCanvasSize;
    window.triggerRDPFlush = triggerRDPFlush;
    
    // 测试canvas渲染的函数
    function testCanvasRendering() {
        var canvas = Mstsc.$("myCanvas");
        if (!canvas) {
            return;
        }
        
        // 确保canvas可见
        canvas.style.display = 'inline';
        
        // 强制刷新canvas尺寸
        refreshCanvasSize();
        
        // 验证canvas尺寸
        if (canvas.width <= 0 || canvas.height <= 0) {
            return;
        }
        
        var ctx = canvas.getContext('2d');
        if (!ctx) {
            return;
        }
        
        // 清除canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // 绘制测试图案
        ctx.fillStyle = '#ff0000';
        ctx.fillRect(0, 0, 100, 100);
        
        ctx.fillStyle = '#00ff00';
        ctx.fillRect(100, 0, 100, 100);
        
        ctx.fillStyle = '#0000ff';
        ctx.fillRect(0, 100, 100, 100);
        
        ctx.fillStyle = '#ffff00';
        ctx.fillRect(100, 100, 100, 100);
        
        // 绘制文字
        ctx.fillStyle = '#000000';
        ctx.font = '20px Arial';
        ctx.fillText('Canvas测试 - 如果你能看到这个文字，说明canvas渲染正常', 10, 250);
        
        // 绘制边框
        ctx.strokeStyle = '#000000';
        ctx.lineWidth = 2;
        ctx.strokeRect(0, 0, canvas.width, canvas.height);
        
        // 验证渲染结果
        setTimeout(function() {
            var rect = canvas.getBoundingClientRect();
            // 测试后Canvas状态
        }, 100);
    }
    
    window.testCanvasRendering = testCanvasRendering;
</script>
  </head>

  <body onload="waitForModulesAndLoad()" class="bg-light">

    <div id="main" class="container d-flex flex-column justify-content-center align-items-center min-vh-100">
        <form class="form-signin shadow rounded-3 p-4 bg-white" style="max-width: 400px; width: 100%;" onSubmit="connect(this.elements['inputIpAddress'].value, this.elements['inputDomain'].value, this.elements['inputUsername'].value, this.elements['inputPassword'].value);return false;">
            <img class='logo mb-3' src="../img/mstsc.js.svg" alt="logo">
            <h2 class="mb-4 text-center text-primary">远程桌面登录</h2>
            <label for="inputIpAddress" class="form-label">IP 地址</label>
            <input type="text" id="inputIpAddress" class="form-control mb-2" placeholder="IP Address" required autofocus>
            <label for="inputDomain" class="form-label">域</label>
            <input type="text" id="inputDomain" class="form-control mb-2" placeholder="Domain">
            <label for="inputUsername" class="form-label">用户名</label>
            <input type="text" id="inputUsername" class="form-control mb-2" placeholder="Username">
            <label for="inputPassword" class="form-label">密码</label>
            <input type="password" id="inputPassword" class="form-control mb-3" placeholder="Password">
            <button class="btn btn-lg btn-primary w-100" type="submit">连接</button>
        </form>
    </div> <!-- /container -->
    <canvas id="myCanvas" style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #f8fafc; border-radius: 8px; box-shadow: 0 2px 16px rgba(0,0,0,0.08); z-index: 10;"></canvas>
  </body>
</html>
