# 鼠标拖拽功能测试指南

## 修复内容

### 鼠标拖拽问题修复

**问题描述：** 鼠标无法拖拽界面

**修复内容：**
- 改进了 `client_piko/web/js/client.js` 中的鼠标拖拽逻辑
- 在拖拽时发送正确的鼠标事件，保持按下状态而不是重复发送按下事件
- 添加了鼠标状态跟踪，包括拖拽状态和按下的按钮

## 测试步骤

### 1. 启动应用
```bash
cd /home/friddle/project/friddle_projects/grdp
make build
./dist/goxrdp
```

### 2. 连接RDP
- 打开浏览器访问应用
- 输入RDP连接信息并连接

### 3. 测试鼠标拖拽功能

#### 测试窗口拖拽
1. 在RDP会话中，尝试拖拽窗口标题栏
2. 观察窗口是否能正常移动
3. 检查拖拽过程中是否有卡顿或异常

#### 测试文件拖拽
1. 在RDP会话中打开文件管理器
2. 尝试拖拽文件或文件夹
3. 观察拖拽操作是否正常

#### 测试文本选择拖拽
1. 在文本编辑器中输入一些文本
2. 尝试拖拽选择文本
3. 观察文本选择是否正常

### 4. 观察日志

#### 后端日志
```bash
# 查看鼠标事件日志
grep "鼠标事件" logs/app.log
grep "转发鼠标" logs/app.log
```

#### 前端日志
在浏览器开发者工具的控制台中观察：
- 鼠标事件是否正确发送
- 是否有拖拽相关的错误信息

### 5. 预期结果

**正常情况：**
- 窗口可以正常拖拽移动
- 文件可以正常拖拽
- 文本可以正常选择拖拽
- 鼠标事件在日志中正常记录

**异常情况：**
- 如果仍有拖拽问题，检查日志中的错误信息
- 观察是否有全黑位图警告（这是另一个修复的功能）

## 调试信息

### 鼠标状态跟踪
修复后的代码会跟踪以下鼠标状态：
- `isDragging`: 是否正在拖拽
- `pressedButtons`: 当前按下的按钮集合
- `lastX`, `lastY`: 最后鼠标位置
- `lastMoveTime`: 最后移动时间（用于节流）

### 拖拽逻辑改进
- 拖拽时保持按钮按下状态，而不是重复发送按下事件
- 使用节流机制减少鼠标移动事件的频率
- 正确处理鼠标按钮的按下和释放

## 相关文件

- `client_piko/web/js/client.js` - 鼠标事件处理逻辑
- `client_piko/bitmap.go` - 位图处理（包含全黑检测）
- `client_piko/web/js/canvas.js` - 前端位图渲染

## 注意事项

1. 确保RDP连接稳定
2. 检查网络延迟是否影响拖拽响应
3. 如果仍有问题，可以启用调试模式：
   ```bash
   export IMAGE_DEBUG=true
   ./dist/goxrdp
   ``` 